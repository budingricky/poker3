name: Build iOS IPA (Capacitor)

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14
    env:
      WORKDIR: client/app
      IOS_DIR: client/app/ios/App
      TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
      IOS_MARKETING_VERSION: ${{ secrets.IOS_MARKETING_VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install JS deps
        run: npm ci

      - name: Build web
        run: npm --workspace client/app run build

      - name: Capacitor sync (iOS)
        run: |
          cd "$WORKDIR"
          npx cap sync ios

      - name: Validate required secrets
        run: |
          set -euo pipefail
          missing=0
          req() {
            name="$1"
            val="$2"
            if [ -z "${val:-}" ]; then
              echo "::error title=Missing secret::Secret ${name} is not set"
              missing=1
            fi
          }
          req "APPLE_TEAM_ID" "${TEAM_ID:-}"
          req "IOS_BUNDLE_ID" "${BUNDLE_ID:-}"
          req "IOS_CERT_P12_BASE64" "${{ secrets.IOS_CERT_P12_BASE64 }}"
          req "IOS_CERT_PASSWORD" "${{ secrets.IOS_CERT_PASSWORD }}"
          req "IOS_PROVISIONING_PROFILE_BASE64" "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}"
          req "KEYCHAIN_PASSWORD" "${{ secrets.KEYCHAIN_PASSWORD }}"
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Setup signing (p12 + provisioning profile)
        env:
          IOS_CERT_P12_BASE64: ${{ secrets.IOS_CERT_P12_BASE64 }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail
          CERT_P12_PATH="$RUNNER_TEMP/cert.p12"
          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"

          decode_b64() {
            if base64 --help 2>&1 | grep -q -- '--decode'; then
              base64 --decode
            else
              base64 -D
            fi
          }
          echo "$IOS_CERT_P12_BASE64" | decode_b64 > "$CERT_P12_PATH"
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | decode_b64 > "$PROFILE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_P12_PATH" -P "$IOS_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/"

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods

      - name: Pod install
        run: |
          cd "$IOS_DIR"
          pod install --repo-update

      - name: Archive
        run: |
          set -euo pipefail
          cd "$IOS_DIR"
          BUILD_NUMBER="${GITHUB_RUN_NUMBER}"
          VERSION="${IOS_MARKETING_VERSION:-1.0.0}"
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "$RUNNER_TEMP/App.xcarchive" \
            -allowProvisioningUpdates \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            MARKETING_VERSION="$VERSION" \
            CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
            archive

      - name: Export IPA
        run: |
          set -euo pipefail
          EXPORT_PLIST="$GITHUB_WORKSPACE/client/app/ios/ExportOptions.plist"
          sed -i '' "s/__TEAM_ID__/$TEAM_ID/g" "$EXPORT_PLIST"
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/App.xcarchive" \
            -exportPath "$RUNNER_TEMP/ipa" \
            -exportOptionsPlist "$EXPORT_PLIST"

      - name: Install fastlane
        if: ${{ secrets.APPSTORE_API_KEY_P8_BASE64 != '' }}
        run: |
          sudo gem install fastlane

      - name: Upload to TestFlight
        if: ${{ secrets.APPSTORE_API_KEY_P8_BASE64 != '' }}
        env:
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_API_KEY_P8_BASE64: ${{ secrets.APPSTORE_API_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          IPA_PATH="$(ls -1 "$RUNNER_TEMP/ipa/"*.ipa | head -n 1)"
          KEY_JSON="$RUNNER_TEMP/appstore_api_key.json"
          KEY_P8="$RUNNER_TEMP/AuthKey.p8"
          decode_b64() {
            if base64 --help 2>&1 | grep -q -- '--decode'; then
              base64 --decode
            else
              base64 -D
            fi
          }
          echo "$APPSTORE_API_KEY_P8_BASE64" | decode_b64 > "$KEY_P8"

          KEY_P8_PATH="$KEY_P8" KEY_JSON_PATH="$KEY_JSON" python3 - <<'PY'
import json, os
key_id = os.environ["APPSTORE_KEY_ID"]
issuer_id = os.environ["APPSTORE_ISSUER_ID"]
path = os.environ["KEY_P8_PATH"]
with open(path, "r", encoding="utf-8") as f:
    key = f.read()
obj = {"key_id": key_id, "issuer_id": issuer_id, "key": key, "in_house": False}
with open(os.environ["KEY_JSON_PATH"], "w", encoding="utf-8") as f:
    json.dump(obj, f)
PY
          fastlane pilot upload --ipa "$IPA_PATH" --api_key_path "$KEY_JSON" --skip_waiting_for_build_processing true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: poker3-ipa
          path: ${{ runner.temp }}/ipa/*.ipa
