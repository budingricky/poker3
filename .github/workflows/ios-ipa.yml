name: Build iOS IPA (Capacitor)

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14
    env:
      WORKDIR: client/app
      IOS_DIR: client/app/ios/App
      TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
      IOS_MARKETING_VERSION: ${{ secrets.IOS_MARKETING_VERSION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.2"

      - name: Xcode version
        run: xcodebuild -version

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install JS deps
        run: npm ci

      - name: Build web assets
        run: npm --workspace client/app run build

      - name: Patch Podfile for CI (fix "Could not automatically select an Xcode project")
        run: |
          set -euo pipefail
          cd "$IOS_DIR"
          # 如果 Podfile 不存在（极少见），创建标准 Capacitor Podfile
          if [ ! -f Podfile ]; then
            cat > Podfile <<'EOF'
          require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'

          platform :ios, '13.0'
          install! 'cocoapods', :deterministic_uuids => false

          target 'App' do
            capacitor_pods
            # Add your Pods here
          end

          post_install do |installer|
            assertDeploymentTarget(installer)
          end
          EOF
            echo "Created missing Podfile"
          fi

          # 确保 Podfile 包含 project 指定（CI 环境下 CocoaPods 经常需要显式指定）
          if ! grep -q "project 'App.xcodeproj'" Podfile; then
            sed -i '' '3i\
          project '\''App.xcodeproj'\''
            ' Podfile
            echo "Added 'project App.xcodeproj' to Podfile"
          fi

          # 额外保险：确保 platform 版本合理（Xcode 16.2 默认支持 iOS 18）
          if ! grep -q "platform :ios" Podfile; then
            sed -i '' '3i\
          platform :ios, '\''13.0'\''
            ' Podfile
          fi

      - name: Capacitor sync iOS
        run: |
          cd "$WORKDIR"
          npx cap sync ios

      - name: Validate required secrets
        run: |
          set -euo pipefail
          missing=0
          req() {
            name="$1"
            val="$2"
            if [ -z "${val:-}" ]; then
              echo "::error title=Missing secret::Secret ${name} is not set"
              missing=1
            fi
          }
          req "APPLE_TEAM_ID" "${TEAM_ID:-}"
          req "IOS_BUNDLE_ID" "${BUNDLE_ID:-}"
          req "APPSTORE_ISSUER_ID" "${{ secrets.APPSTORE_ISSUER_ID }}"
          req "APPSTORE_KEY_ID" "${{ secrets.APPSTORE_KEY_ID }}"
          req "APPSTORE_API_KEY_P8_BASE64" "${{ secrets.APPSTORE_API_KEY_P8_BASE64 }}"
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Setup App Store Connect API Key
        env:
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_API_KEY_P8_BASE64: ${{ secrets.APPSTORE_API_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          decode_b64() {
            if base64 --help 2>&1 | grep -q -- '--decode'; then
              base64 --decode
            else
              base64 -D
            fi
          }
          KEY_P8="$RUNNER_TEMP/AuthKey.p8"
          printf '%s' "$APPSTORE_API_KEY_P8_BASE64" | decode_b64 > "$KEY_P8"
          echo "XCODE_AUTH_KEY_PATH=$KEY_P8" >> "$GITHUB_ENV"
          echo "XCODE_AUTH_KEY_ID=$APPSTORE_KEY_ID" >> "$GITHUB_ENV"
          echo "XCODE_AUTH_ISSUER_ID=$APPSTORE_ISSUER_ID" >> "$GITHUB_ENV"

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Pod install (with repo update)
        run: |
          cd "$IOS_DIR"
          pod install --repo-update

      - name: Archive (Automatic Signing)
        run: |
          set -euo pipefail
          cd "$IOS_DIR"

          BUILD_NUMBER="${GITHUB_RUN_NUMBER}"
          VERSION="${IOS_MARKETING_VERSION:-1.0.0}"

          echo "=== Build Settings Debug ==="
          xcodebuild -workspace App.xcworkspace -scheme App -showBuildSettings | grep -E "CODE_SIGN_STYLE|DEVELOPMENT_TEAM|PRODUCT_BUNDLE_IDENTIFIER"

          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath "$RUNNER_TEMP/App.xcarchive" \
            "App/CODE_SIGN_STYLE"=Automatic \
            "App/DEVELOPMENT_TEAM"="$TEAM_ID" \
            "App/PRODUCT_BUNDLE_IDENTIFIER"="$BUNDLE_ID" \
            "App/MARKETING_VERSION"="$VERSION" \
            "App/CURRENT_PROJECT_VERSION"="$BUILD_NUMBER" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$XCODE_AUTH_KEY_PATH" \
            -authenticationKeyID "$XCODE_AUTH_KEY_ID" \
            -authenticationKeyIssuerID "$XCODE_AUTH_ISSUER_ID" \
            archive

      - name: Export IPA
        run: |
          set -euo pipefail
          EXPORT_PLIST="$RUNNER_TEMP/exportOptions.plist"
          cat > "$EXPORT_PLIST" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/App.xcarchive" \
            -exportPath "$RUNNER_TEMP/ipa" \
            -exportOptionsPlist "$EXPORT_PLIST" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$XCODE_AUTH_KEY_PATH" \
            -authenticationKeyID "$XCODE_AUTH_KEY_ID" \
            -authenticationKeyIssuerID "$XCODE_AUTH_ISSUER_ID"

      - name: Install fastlane
        run: sudo gem install fastlane

      - name: Upload to TestFlight
        env:
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_API_KEY_P8_BASE64: ${{ secrets.APPSTORE_API_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          if [ -z "${APPSTORE_API_KEY_P8_BASE64:-}" ] || [ -z "${APPSTORE_ISSUER_ID:-}" ] || [ -z "${APPSTORE_KEY_ID:-}" ]; then
            echo "Skip TestFlight upload: missing App Store Connect API key secrets"
            exit 0
          fi

          IPA_PATH=$(find "$RUNNER_TEMP/ipa" -name "*.ipa" | head -n 1)
          KEY_JSON="$RUNNER_TEMP/appstore_api_key.json"
          KEY_P8="$RUNNER_TEMP/AuthKey.p8"

          decode_b64() {
            if base64 --help 2>&1 | grep -q -- '--decode'; then
              base64 --decode
            else
              base64 -D
            fi
          }
          printf '%s' "$APPSTORE_API_KEY_P8_BASE64" | decode_b64 > "$KEY_P8"

          python3 - <<PY
          import json, os
          key = open("$KEY_P8", "r", encoding="utf-8").read()
          data = {
              "key_id": "${APPSTORE_KEY_ID}",
              "issuer_id": "${APPSTORE_ISSUER_ID}",
              "key": key,
              "in_house": False
          }
          with open("$KEY_JSON", "w", encoding="utf-8") as f:
              json.dump(data, f)
          PY

          fastlane pilot upload \
            --ipa "$IPA_PATH" \
            --api_key_path "$KEY_JSON" \
            --skip_waiting_for_build_processing true

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: poker3-ipa
          path: ${{ runner.temp }}/ipa/*.ipa