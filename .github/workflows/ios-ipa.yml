name: Build iOS IPA (Capacitor)

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14
    env:
      WORKDIR: client/app
      IOS_DIR: client/app/ios/App
      TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
      IOS_MARKETING_VERSION: ${{ secrets.IOS_MARKETING_VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.0"

      - name: Xcode version
        run: xcodebuild -version

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install JS deps
        run: npm ci

      - name: Build web
        run: npm --workspace client/app run build

      - name: Capacitor sync (iOS)
        run: |
          cd "$WORKDIR"
          npx cap sync ios

      - name: Validate required secrets
        run: |
          set -euo pipefail
          missing=0
          req() {
            name="$1"
            val="$2"
            if [ -z "${val:-}" ]; then
              echo "::error title=Missing secret::Secret ${name} is not set"
              missing=1
            fi
          }
          req "APPLE_TEAM_ID" "${TEAM_ID:-}"
          req "IOS_BUNDLE_ID" "${BUNDLE_ID:-}"
          req "IOS_CERT_P12_BASE64" "${{ secrets.IOS_CERT_P12_BASE64 }}"
          req "IOS_CERT_PASSWORD" "${{ secrets.IOS_CERT_PASSWORD }}"
          req "KEYCHAIN_PASSWORD" "${{ secrets.KEYCHAIN_PASSWORD }}"
          req "APPSTORE_ISSUER_ID" "${{ secrets.APPSTORE_ISSUER_ID }}"
          req "APPSTORE_KEY_ID" "${{ secrets.APPSTORE_KEY_ID }}"
          req "APPSTORE_API_KEY_P8_BASE64" "${{ secrets.APPSTORE_API_KEY_P8_BASE64 }}"
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Setup signing (p12 + provisioning profile)
        env:
          IOS_CERT_P12_BASE64: ${{ secrets.IOS_CERT_P12_BASE64 }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail
          CERT_P12_PATH="$RUNNER_TEMP/cert.p12"
          CERT_CRT_PATH="$RUNNER_TEMP/cert.crt.pem"
          CERT_KEY_PATH="$RUNNER_TEMP/cert.key.pem"
          CERT_CRT_CLEAN_PATH="$RUNNER_TEMP/cert.clean.pem"
          CERT_KEY_CLEAN_PATH="$RUNNER_TEMP/key.clean.pem"
          CERT_KEY_TRAD_PATH="$RUNNER_TEMP/key.traditional.pem"
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"

          decode_b64() {
            if base64 --help 2>&1 | grep -q -- '--decode'; then
              base64 --decode
            else
              base64 -D
            fi
          }
          printf '%s' "$IOS_CERT_P12_BASE64" | decode_b64 > "$CERT_P12_PATH"

          openssl pkcs12 -in "$CERT_P12_PATH" -passin "pass:$IOS_CERT_PASSWORD" -info -noout >/dev/null
          openssl pkcs12 -in "$CERT_P12_PATH" -passin "pass:$IOS_CERT_PASSWORD" -clcerts -nokeys -out "$CERT_CRT_PATH" >/dev/null
          openssl pkcs12 -in "$CERT_P12_PATH" -passin "pass:$IOS_CERT_PASSWORD" -nocerts -nodes -out "$CERT_KEY_PATH" >/dev/null
          awk 'BEGIN{p=0} /-----BEGIN CERTIFICATE-----/{p=1} p{print} /-----END CERTIFICATE-----/{p=0}' "$CERT_CRT_PATH" > "$CERT_CRT_CLEAN_PATH"
          awk 'BEGIN{p=0} /-----BEGIN .*PRIVATE KEY-----/{p=1} p{print} /-----END .*PRIVATE KEY-----/{p=0}' "$CERT_KEY_PATH" > "$CERT_KEY_CLEAN_PATH"
          if openssl pkey -in "$CERT_KEY_CLEAN_PATH" -out "$CERT_KEY_TRAD_PATH" -traditional 2>/dev/null; then
            :
          else
            openssl rsa -in "$CERT_KEY_CLEAN_PATH" -out "$CERT_KEY_TRAD_PATH" >/dev/null
          fi

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security import "$CERT_CRT_CLEAN_PATH" -A -t cert -f pemseq -k "$KEYCHAIN_PATH"
          security import "$CERT_KEY_TRAD_PATH" -A -t priv -f openssl -k "$KEYCHAIN_PATH" -P ""
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Signing debug
        run: |
          set -euo pipefail
          echo "Keychain: $KEYCHAIN_PATH"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true
      - name: Setup App Store Connect API key (for Xcode)
        env:
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_API_KEY_P8_BASE64: ${{ secrets.APPSTORE_API_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          decode_b64() {
            if base64 --help 2>&1 | grep -q -- '--decode'; then
              base64 --decode
            else
              base64 -D
            fi
          }
          KEY_P8="$RUNNER_TEMP/AuthKey.p8"
          printf '%s' "$APPSTORE_API_KEY_P8_BASE64" | decode_b64 > "$KEY_P8"
          echo "XCODE_AUTH_KEY_PATH=$KEY_P8" >> "$GITHUB_ENV"
          echo "XCODE_AUTH_KEY_ID=$APPSTORE_KEY_ID" >> "$GITHUB_ENV"
          echo "XCODE_AUTH_ISSUER_ID=$APPSTORE_ISSUER_ID" >> "$GITHUB_ENV"

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods

      - name: Pod install
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd "$IOS_DIR"
          pod install --repo-update

      - name: Archive
        run: |
          set -euo pipefail
          cd "$IOS_DIR"
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          BUILD_NUMBER="${GITHUB_RUN_NUMBER}"
          VERSION="${IOS_MARKETING_VERSION:-1.0.0}"
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath "$RUNNER_TEMP/App.xcarchive" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH" \
            MARKETING_VERSION="$VERSION" \
            CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$XCODE_AUTH_KEY_PATH" \
            -authenticationKeyID "$XCODE_AUTH_KEY_ID" \
            -authenticationKeyIssuerID "$XCODE_AUTH_ISSUER_ID" \
            archive

      - name: Export IPA
        run: |
          set -euo pipefail
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          EXPORT_PLIST="$RUNNER_TEMP/exportOptions.plist"
          cat > "$EXPORT_PLIST" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>destination</key>
            <string>export</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF
          plutil -lint "$EXPORT_PLIST"
          if [ -d "$RUNNER_TEMP/App.xcarchive/Products/Applications" ]; then
            APP_PATH="$(find "$RUNNER_TEMP/App.xcarchive/Products/Applications" -maxdepth 1 -name "*.app" | head -n 1 || true)"
            if [ -n "${APP_PATH:-}" ]; then
              echo "Archive app: $APP_PATH"
              echo "Embedded frameworks:"
              ls -la "$APP_PATH/Frameworks" || true
              codesign -dv --verbose=2 "$APP_PATH" 2>&1 | sed -n '1,120p' || true
              for fw in "$APP_PATH/Frameworks/"*.framework; do
                [ -e "$fw" ] || continue
                echo "codesign: $fw"
                codesign -dv --verbose=2 "$fw" 2>&1 | sed -n '1,120p' || true
              done
            fi
          fi
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/App.xcarchive" \
            -exportPath "$RUNNER_TEMP/ipa" \
            -exportOptionsPlist "$EXPORT_PLIST" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$XCODE_AUTH_KEY_PATH" \
            -authenticationKeyID "$XCODE_AUTH_KEY_ID" \
            -authenticationKeyIssuerID "$XCODE_AUTH_ISSUER_ID" \
            -verbose

      - name: Install fastlane
        run: |
          sudo gem install fastlane

      - name: Upload to TestFlight
        env:
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_API_KEY_P8_BASE64: ${{ secrets.APPSTORE_API_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          if [ -z "${APPSTORE_API_KEY_P8_BASE64:-}" ] || [ -z "${APPSTORE_ISSUER_ID:-}" ] || [ -z "${APPSTORE_KEY_ID:-}" ]; then
            echo "Skip TestFlight upload: APPSTORE_* secrets not configured."
            exit 0
          fi
          IPA_PATH="$(ls -1 "$RUNNER_TEMP/ipa/"*.ipa | head -n 1)"
          KEY_JSON="$RUNNER_TEMP/appstore_api_key.json"
          KEY_P8="$RUNNER_TEMP/AuthKey.p8"
          decode_b64() {
            if base64 --help 2>&1 | grep -q -- '--decode'; then
              base64 --decode
            else
              base64 -D
            fi
          }
          printf '%s' "$APPSTORE_API_KEY_P8_BASE64" | decode_b64 > "$KEY_P8"

          KEY_P8_PATH="$KEY_P8" KEY_JSON_PATH="$KEY_JSON" python3 -c 'import json,os; key=open(os.environ["KEY_P8_PATH"],"r",encoding="utf-8").read(); json.dump({"key_id":os.environ["APPSTORE_KEY_ID"],"issuer_id":os.environ["APPSTORE_ISSUER_ID"],"key":key,"in_house":False}, open(os.environ["KEY_JSON_PATH"],"w",encoding="utf-8"))'
          fastlane pilot upload --ipa "$IPA_PATH" --api_key_path "$KEY_JSON" --skip_waiting_for_build_processing true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: poker3-ipa
          path: ${{ runner.temp }}/ipa/*.ipa
