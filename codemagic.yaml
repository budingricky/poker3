workflows:
  ios-manual-fix:
    name: "ğŸ† Manual Signing (Fixed)"
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - manual_signing  # ä½ çš„ç»„å
      node: 20
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
    scripts:
      - name: "Install & Build Web"
        script: |
          cd client/app
          npm install
          npm run build
          npx cap sync ios

      - name: "Initialize Keychain"
        script: keychain initialize

      - name: "âœï¸ MANUAL SETUP: Import Certificate"
        script: |
          echo "æ­£åœ¨å¯¼å…¥æ‰‹åŠ¨ä¸Šä¼ çš„è¯ä¹¦..."
          # 1. è§£ç  P12
          echo $CM_CERTIFICATE | base64 --decode > /tmp/certificate.p12
          
          # 2. å¯¼å…¥é’¥åŒ™ä¸²
          keychain add-certificates --certificate /tmp/certificate.p12 --certificate-password "$CM_CERTIFICATE_PASSWORD"

      - name: "ğŸ“ MANUAL SETUP: Import Profile"
        script: |
          echo "æ­£åœ¨å¯¼å…¥æ‰‹åŠ¨ä¸Šä¼ çš„æè¿°æ–‡ä»¶..."
          # 1. è§£ç æè¿°æ–‡ä»¶
          echo $CM_PROVISIONING_PROFILE | base64 --decode > /tmp/profile.mobileprovision
          
          # 2. æ”¾åˆ°ç³»ç»Ÿç›®å½•
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: "âš™ï¸ APPLY SIGNING SETTINGS"
        script: |
          # ğŸ”¥ ä¿®æ­£ç‚¹ï¼šåœ¨è¿™é‡Œå‘Šè¯‰ Xcode ä½¿ç”¨æˆ‘ä»¬åˆšæ‰æ”¾å…¥çš„æè¿°æ–‡ä»¶
          # å®ƒä¼šè‡ªåŠ¨æ‰«æ ~/Library/MobileDevice/Provisioning Profiles ä¸‹çš„æ–‡ä»¶
          # å¹¶ä¿®æ”¹ Xcode å·¥ç¨‹è®¾ç½®ä¸º "Manual" ç­¾å
          xcode-project use-profiles --project "client/app/ios/App/App.xcodeproj"

      - name: "Build IPA"
        script: |
          # ğŸ”¥ ä¿®æ­£ç‚¹ï¼šå»æ‰äº†ä¸æ”¯æŒçš„å‚æ•°
          # å› ä¸ºä¸Šä¸€æ­¥ use-profiles å·²ç»é…ç½®å¥½äº†ç­¾åä¿¡æ¯ï¼Œè¿™é‡Œç›´æ¥æ„å»ºå³å¯
          xcode-project build-ipa \
            --workspace "client/app/ios/App/App.xcworkspace" \
            --scheme "App"

    artifacts:
      - build/ios/ipa/*.ipa