workflows:
  ios-final-cleanup:
    name: "ğŸ’€ Final Nuclear Clean-up"
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - apple_credentials
      node: 20
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
    scripts:
      - name: "ğŸ’£ NUKE DISTRIBUTION CERTS (Fixed)"
        script: |
          echo "ğŸ” æ­£åœ¨æœç´¢æ‰€æœ‰å‘å¸ƒè¯ä¹¦..."
          
          # 1. ç›´æ¥æ‰“å°åˆ—è¡¨åˆ°æ—¥å¿— (æ–¹ä¾¿ä½ æŸ¥çœ‹) å¹¶ä¿å­˜åˆ°æ–‡ä»¶
          # è¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬è¡¨æ ¼ï¼Œæˆ‘ä»¬ç¨åç”¨ awk æå–ç¬¬ä¸€åˆ—çš„ ID
          app-store-connect certificates list --type IOS_DISTRIBUTION > certs.txt || true
          cat certs.txt
          
          # 2. æå– ID å¹¶é€ä¸ªåˆ é™¤
          # é€»è¾‘ï¼šè·³è¿‡ç¬¬ä¸€è¡Œæ ‡é¢˜ï¼Œæå–ç¬¬ä¸€åˆ— ID
          echo "âš ï¸ å‡†å¤‡æ‰§è¡Œåˆ é™¤æ“ä½œ..."
          ids=$(awk 'NR>1 {print $1}' certs.txt)
          
          if [ -z "$ids" ]; then
              echo "âœ… æœªå‘ç°å‘å¸ƒè¯ä¹¦ï¼Œç¯å¢ƒæ˜¯å¹²å‡€çš„ã€‚"
          else
              for id in $ids; do
                  echo "ğŸš« å‘ç°å¹½çµè¯ä¹¦ ID: $id - æ­£åœ¨é”€æ¯..."
                  # å¿½ç•¥é”™è¯¯ç»§ç»­åˆ ä¸‹ä¸€ä¸ª
                  app-store-connect certificates revoke --id $id || true
              done
          fi
          
          echo "âœ… è¯ä¹¦æ¸…ç†å®Œæ¯•ï¼"

      - name: "Install & Build Web"
        script: |
          cd client/app
          npm install
          npm run build
          npx cap sync ios

      - name: "Initialize Keychain"
        script: keychain initialize

      - name: "Auto Code Signing (Fresh Start)"
        script: |
          PROJECT_PATH="client/app/ios/App/App.xcodeproj"
          APP_ID=$(xcode-project detect-bundle-id --project "$PROJECT_PATH")
          echo "App ID: $APP_ID"
          
          # æ­¤æ—¶ç¯å¢ƒå·²è¢«è„šæœ¬æ¸…ç©ºï¼Œ--create å‚æ•°å°†å¼ºåˆ¶ç”Ÿæˆæ–°è¯ä¹¦
          app-store-connect fetch-signing-files "$APP_ID" --type IOS_APP_STORE --create
          
          keychain add-certificates

      - name: "Build IPA"
        script: |
          xcode-project use-profiles --project "client/app/ios/App/App.xcodeproj"
          xcode-project build-ipa \
            --workspace "client/app/ios/App/App.xcworkspace" \
            --scheme "App"

    artifacts:
      - client/app/ios/App/build/*.ipa