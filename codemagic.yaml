workflows:
  ios-smart-fix:
    name: "ğŸ› ï¸ Final Smart Fix (Auto-Nuke)"
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - apple_credentials
      node: 20
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
    scripts:
      - name: "ğŸ’£ SMART CLEANUP (Nuke All Distribution Types)"
        script: |
          echo "ğŸ” æ­£åœ¨æ‰«ææ‰€æœ‰ç±»å‹çš„è¯ä¹¦..."
          
          # 1. ä¸åŠ ä»»ä½•è¿‡æ»¤å™¨ï¼Œä¸‹è½½æ‰€æœ‰è¯ä¹¦ä¿¡æ¯åˆ°æ–‡ä»¶
          app-store-connect certificates list > all_certs.txt 2>&1
          
          # 2. ä½¿ç”¨ Python æ™ºèƒ½åˆ†æå¹¶åˆ é™¤
          # é€»è¾‘ï¼šåªè¦ç±»å‹æˆ–åç§°é‡ŒåŒ…å« 'DISTRIBUTION'ï¼Œç»Ÿç»Ÿåˆ æ‰
          python3 -c "
          import sys, re, subprocess

          def run_cmd(cmd):
              subprocess.run(cmd, shell=True)

          print('-------- åˆ†æè¯ä¹¦åˆ—è¡¨ --------')
          try:
              with open('all_certs.txt', 'r') as f:
                  lines = f.readlines()
                  
              # è·³è¿‡è¡¨å¤´ï¼Œä»ç¬¬3è¡Œå¼€å§‹è¯»å– (æ ¹æ®æ—¥å¿—æ ¼å¼è°ƒæ•´)
              # å…¸å‹æ ¼å¼: ID  Name  Type  Serial ...
              found_ghost = False
              for line in lines:
                  if 'DISTRIBUTION' in line.upper():
                      parts = line.split()
                      if len(parts) > 0:
                          cert_id = parts[0]
                          print(f'ğŸš« å‘ç°å‘å¸ƒè¯ä¹¦ (ID: {cert_id}) -> æ­£åœ¨é”€æ¯...')
                          run_cmd(f'app-store-connect certificates revoke --id {cert_id}')
                          found_ghost = True
              
              if not found_ghost:
                  print('âœ… æœªå‘ç°ä»»ä½•å‘å¸ƒè¯ä¹¦ (ç¯å¢ƒå¹²å‡€)')

          except Exception as e:
              print(f'è„šæœ¬æ‰§è¡Œå‡ºé”™: {e}')
          print('-----------------------------')
          "

          # 3. æ¸…ç†æ—§çš„æè¿°æ–‡ä»¶ (Profiles)
          # åŒæ ·ä¸åŠ è¿‡æ»¤å™¨ï¼Œæ‹‰å–æ‰€æœ‰ Profiles
          echo "ğŸ” æ­£åœ¨æ¸…ç†æè¿°æ–‡ä»¶..."
          app-store-connect profiles list > all_profiles.txt 2>&1
          python3 -c "
          import subprocess
          with open('all_profiles.txt', 'r') as f:
              for line in f:
                  # åªè¦åŒ…å« App ID çš„æè¿°æ–‡ä»¶éƒ½åˆ æ‰
                  if 'com.poker4.client' in line:
                      parts = line.split()
                      if len(parts) > 0:
                          pid = parts[0]
                          print(f'ğŸ—‘ï¸ åˆ é™¤æ—§Profile: {pid}')
                          subprocess.run(f'app-store-connect profiles delete --id {pid}', shell=True)
          "

      - name: "Install & Build Web"
        script: |
          cd client/app
          npm install
          npm run build
          npx cap sync ios

      - name: "Initialize Keychain"
        script: keychain initialize

      - name: "Auto Code Signing (Rebirth)"
        script: |
          PROJECT_PATH="client/app/ios/App/App.xcodeproj"
          APP_ID=$(xcode-project detect-bundle-id --project "$PROJECT_PATH")
          echo "App ID: $APP_ID"
          
          # ğŸ”¥ é‡ç‚¹ï¼š
          # ç°åœ¨ç¯å¢ƒç»å¯¹å¹²å‡€äº†ï¼ˆæ‰€æœ‰Distributionéƒ½è¢«åˆ äº†ï¼‰
          # --create å‚æ•°ä¼šå‘ç°æ²¡æœ‰è¯ä¹¦ï¼Œä»è€Œå¼ºåˆ¶åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„
          # å¹¶ä¸”å› ä¸ºæ˜¯æ–°å»ºçš„ï¼Œç§é’¥ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œä¸ä¼šå†æŠ¥ 'Cannot save' é”™è¯¯
          app-store-connect fetch-signing-files "$APP_ID" --type IOS_APP_STORE --create
          
          keychain add-certificates

      - name: "Build IPA"
        script: |
          xcode-project use-profiles --project "client/app/ios/App/App.xcodeproj"
          xcode-project build-ipa \
            --workspace "client/app/ios/App/App.xcworkspace" \
            --scheme "App"

    artifacts:
      - client/app/ios/App/build/*.ipa