workflows:
  ios-build:
    name: iOS Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - apple_credentials # ä½ çš„ç¯å¢ƒå˜é‡ç»„å
      node: 20
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
    scripts:
      - name: Install dependencies & Build Web
        script: |
          # ğŸ‘‡ 1. è¿›å…¥æ­£ç¡®çš„é¡¹ç›®æ ¹ç›®å½•
          cd client/app

          # 2. å®‰è£…ä¾èµ–å¹¶æ„å»º
          npm install
          npm run build

          # 3. åŒæ­¥ä»£ç åˆ° iOS ç›®å½• (ç°åœ¨å®ƒæ˜¯æ ‡å‡†çš„ client/app/ios)
          npx cap sync ios

      - name: Initialize Keychain
        script: keychain initialize

      - name: Auto Code Signing
        script: |
          # ğŸ‘‡ 4. å‘Šè¯‰ Codemagic ä½ çš„å·¥ç¨‹æ–‡ä»¶åœ¨å“ªé‡Œ
          # è·¯å¾„ç»“æ„: client -> app -> ios -> App -> App.xcodeproj
          PROJECT_PATH="client/app/ios/App/App.xcodeproj"

          # è‡ªåŠ¨è·å– Bundle ID å¹¶ç”³è¯·è¯ä¹¦
          APP_ID=$(xcode-project detect-bundle-id --project "$PROJECT_PATH")
          echo "Detected Bundle ID: $APP_ID"

          app-store-connect fetch-signing-files "$APP_ID" --type IOS_APP_STORE --create
          keychain add-certificates

      - name: Set up code signing
        script: |
          # 5. åº”ç”¨è¯ä¹¦
          PROJECT_PATH="client/app/ios/App/App.xcodeproj"
          xcode-project use-profiles --project "$PROJECT_PATH"

      - name: Build IPA
        script: |
          # 6. æ„å»º IPA
          WORKSPACE_PATH="client/app/ios/App/App.xcworkspace"

          xcode-project build-ipa \
            --workspace "$WORKSPACE_PATH" \
            --scheme "App"

    artifacts:
      - client/app/ios/App/build/*.ipa  # ğŸ‘ˆ ç¡®ä¿è¾“å‡ºè·¯å¾„æ­£ç¡®