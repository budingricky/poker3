workflows:
  ios-terminator-build:
    name: ğŸ’€ Terminator Build (Force Clean)
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - apple_credentials
      node: 20
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
    scripts:
      - name: ğŸ§¹ PRE-FLIGHT: Nuke Everything (å¼ºåˆ¶æ¸…ç†)
        script: |
          echo "âš ï¸ æ­£åœ¨å¯åŠ¨æ ¸å¼¹æ¸…ç†ç¨‹åº..."
          
          # 1. ä¸‹è½½å½“å‰æ‰€æœ‰çš„å‘å¸ƒè¯ä¹¦åˆ—è¡¨ (JSONæ ¼å¼)
          app-store-connect certificates list --type IOS_DISTRIBUTION --save-to-file certs.json
          
          # 2. ä½¿ç”¨ Python è§£æåˆ—è¡¨å¹¶é€ä¸ªæ’¤é”€ (Revoke)
          python3 -c "
          import json, os
          try:
              with open('certs.json') as f:
                  data = json.load(f)
                  certs = data.get('data', [])
                  if not certs:
                      print('âœ… æ²¡æœ‰å‘ç°å¹½çµè¯ä¹¦ï¼Œç¯å¢ƒå¹²å‡€ã€‚')
                  for cert in certs:
                      cert_id = cert['id']
                      print(f'ğŸš« å‘ç°å¹½çµè¯ä¹¦: {cert_id}ï¼Œæ­£åœ¨é”€æ¯...')
                      os.system(f'app-store-connect certificates revoke --id {cert_id}')
          except Exception as e:
              print(f'å¤„ç†è¯ä¹¦æ—¶å‡ºé”™ (å¯èƒ½å·²ç»æ˜¯å¹²å‡€çš„): {e}')
          "

          # 3. ä¸‹è½½æ‰€æœ‰çš„æè¿°æ–‡ä»¶ (Profiles)
          app-store-connect profiles list --type IOS_APP_STORE --save-to-file profiles.json
          
          # 4. åˆ é™¤æ‰€æœ‰ç›¸å…³çš„æè¿°æ–‡ä»¶ (é˜²æ­¢å®ƒå…³è”åˆ°æ—§è¯ä¹¦)
          python3 -c "
          import json, os
          try:
              with open('profiles.json') as f:
                  data = json.load(f)
                  profiles = data.get('data', [])
                  for p in profiles:
                      p_id = p['id']
                      # è¿™é‡Œä¸ºäº†ä¿é™©ï¼ŒæŠŠæ‰€æœ‰çš„å‘å¸ƒæè¿°æ–‡ä»¶éƒ½åˆ äº†ï¼Œåæ­£ä¼šè‡ªåŠ¨é‡å»º
                      print(f'ğŸ—‘ï¸ åˆ é™¤æ—§æè¿°æ–‡ä»¶: {p_id}...')
                      os.system(f'app-store-connect profiles delete --id {p_id}')
          except:
              pass
          "
          echo "âœ… æ¸…ç†å®Œæˆï¼Apple åå°ç°åœ¨æ˜¯ä¸€ç‰‡åºŸå¢Ÿï¼Œå‡†å¤‡é‡å»ºã€‚"

      - name: Install & Build Web
        script: |
          cd client/app
          npm install
          npm run build
          npx cap sync ios

      - name: Initialize Keychain
        script: keychain initialize

      - name: Auto Code Signing (Force New)
        script: |
          # æ­¤æ—¶ç¯å¢ƒå·²çœŸç©ºï¼Œè¿™è¡Œå‘½ä»¤å¿…å®šä¼šåˆ›å»ºæ–°è¯ä¹¦
          PROJECT_PATH="client/app/ios/App/App.xcodeproj"
          APP_ID=$(xcode-project detect-bundle-id --project "$PROJECT_PATH")
          
          # --create å‚æ•°ç°åœ¨ä¼šç•…é€šæ— é˜»
          app-store-connect fetch-signing-files "$APP_ID" --type IOS_APP_STORE --create
          
          keychain add-certificates

      - name: Build IPA
        script: |
          xcode-project use-profiles --project "client/app/ios/App/App.xcodeproj"
          xcode-project build-ipa \
            --workspace "client/app/ios/App/App.xcworkspace" \
            --scheme "App"

    artifacts:
      - client/app/ios/App/build/*.ipa