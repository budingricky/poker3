workflows:
  ios-final-build:
    name: iOS Final Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - apple_credentials
      node: 20
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
    scripts:
      - name: Install dependencies & Build Web
        script: |
          # 1. è¿›å…¥ä½ çš„é¡¹ç›®ç›®å½•
          cd client/app

          # 2. å®‰è£…ä¾èµ–å¹¶æ„å»º
          npm install
          npm run build

          # 3. åŒæ­¥èµ„æº
          npx cap sync ios

      - name: Initialize Keychain
        script: keychain initialize

      - name: Auto Code Signing
        script: |
          # 4. è·¯å¾„ï¼šclient -> app -> ios -> App -> App.xcodeproj
          PROJECT_PATH="client/app/ios/App/App.xcodeproj"

          # è·å– Bundle ID
          APP_ID=$(xcode-project detect-bundle-id --project "$PROJECT_PATH")
          echo "Detected Bundle ID: $APP_ID"

          # ğŸ”¥ å…³é”®ä¸€æ­¥ï¼š
          # å› ä¸ºåˆšæ‰æ£€æµ‹åˆ°è¯ä¹¦åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œè¿™é‡Œå¸¦ä¸Š --create å‚æ•°
          # Codemagic ä¼šå‘ç°æ²¡è¯ä¹¦ï¼Œäºæ˜¯è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼
          app-store-connect fetch-signing-files "$APP_ID" --type IOS_APP_STORE --create
          
          keychain add-certificates

      - name: Set up code signing
        script: |
          PROJECT_PATH="client/app/ios/App/App.xcodeproj"
          xcode-project use-profiles --project "$PROJECT_PATH"

      - name: Build IPA
        script: |
          WORKSPACE_PATH="client/app/ios/App/App.xcworkspace"
          xcode-project build-ipa \
            --workspace "$WORKSPACE_PATH" \
            --scheme "App"

    artifacts:
      - client/app/ios/App/build/*.ipa