workflows:
  ios-forced-creation:
    name: "ğŸ’€ iOS Force Create (Manual Override)"
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - apple_credentials
      node: 20
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
    scripts:
      - name: "Install & Build Web"
        script: |
          cd client/app
          npm install
          npm run build
          npx cap sync ios

      - name: "Initialize Keychain"
        script: keychain initialize

      - name: "ğŸ”¥ FORCE CREATE CERTIFICATE (The Fix)"
        script: |
          echo "ğŸš€ æ­£åœ¨å¼ºåˆ¶åˆ›å»ºæ–°è¯ä¹¦..."
          
          # 1. å®šä¹‰ä¸´æ—¶å­˜å‚¨è·¯å¾„
          CERT_KEY_PATH="dist.p12"
          PROFILE_PATH="dist.mobileprovision"
          
          # 2. è¿™é‡Œçš„å…³é”®æ˜¯ï¼šæˆ‘ä»¬ä¸è®©å®ƒå» fetchï¼Œè€Œæ˜¯ç›´æ¥ create
          # ä½¿ç”¨ app-store-connect å·¥å…·çš„ä¸€ä¸ªç‰¹å®šåŠŸèƒ½æ¥è¯·æ±‚æ–°è¯ä¹¦
          # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æŒ‡æ˜è¦åˆ›å»º IOS_DISTRIBUTION
          
          # è¿™ä¸€æ­¥ä¼šå¼ºåˆ¶è¯·æ±‚ä¸€ä¸ªæ–°çš„ CSR å¹¶æäº¤ç»™ Apple
          app-store-connect certificates create --type IOS_DISTRIBUTION --save-to-file "$CERT_KEY_PATH"
          
          # 3. æŠŠè¿™ä¸ªåˆšå‡ºç‚‰çš„æ–°è¯ä¹¦å¯¼å…¥é’¥åŒ™ä¸²
          # (å› ä¸ºæ˜¯åˆšåˆ›å»ºçš„ï¼Œç§é’¥è‚¯å®šåœ¨æœ¬åœ°ï¼Œæ‰€ä»¥ä¸ä¼šæŠ¥é”™ï¼)
          keychain add-certificates --certificate "$CERT_KEY_PATH"
          
          echo "âœ… æ–°è¯ä¹¦åˆ›å»ºå¹¶å¯¼å…¥æˆåŠŸï¼"

      - name: "ğŸ”¥ FORCE CREATE PROFILE"
        script: |
          PROJECT_PATH="client/app/ios/App/App.xcodeproj"
          APP_ID=$(xcode-project detect-bundle-id --project "$PROJECT_PATH")
          echo "App ID: $APP_ID"
          
          # å¼ºåˆ¶ä¸ºè¿™ä¸ª App ID åˆ›å»ºä¸€ä¸ªæ–°çš„æè¿°æ–‡ä»¶
          app-store-connect profiles create --bundle-id "$APP_ID" --type IOS_APP_STORE --certificate-id $(app-store-connect certificates list --type IOS_DISTRIBUTION --limit 1 | awk 'NR==2 {print $1}') --save-to-file "dist.mobileprovision"
          
          # è¿™ä¸€æ­¥æ˜¯ä¸ºäº†è®© xcode-project use-profiles èƒ½æ‰¾åˆ°å®ƒ
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp dist.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          
          echo "âœ… æ–°æè¿°æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼"

      - name: "Build IPA"
        script: |
          # åº”ç”¨åˆšæ‰å¼ºåˆ¶ç”Ÿæˆçš„é…ç½®
          xcode-project use-profiles --project "client/app/ios/App/App.xcodeproj"
          
          xcode-project build-ipa \
            --workspace "client/app/ios/App/App.xcworkspace" \
            --scheme "App"

    artifacts:
      - client/app/ios/App/build/*.ipa