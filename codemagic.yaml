workflows:
  ios-terminator-build:
    name: "ğŸ’€ Terminator Build (Force Clean)"
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - apple_credentials
      node: 20
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
    scripts:
      - name: "ğŸ§¹ PRE-FLIGHT: Nuke Everything (Force Clean)"
        script: |
          echo "âš ï¸ Starting nuclear clean-up..."
          
          # 1. ä¸‹è½½å½“å‰æ‰€æœ‰çš„å‘å¸ƒè¯ä¹¦åˆ—è¡¨
          app-store-connect certificates list --type IOS_DISTRIBUTION --save-to-file certs.json
          
          # 2. ä½¿ç”¨ Python è§£æåˆ—è¡¨å¹¶é€ä¸ªæ’¤é”€
          python3 -c "
          import json, os
          try:
              with open('certs.json') as f:
                  data = json.load(f)
                  certs = data.get('data', [])
                  if not certs:
                      print('âœ… No ghost certificates found.')
                  for cert in certs:
                      cert_id = cert['id']
                      print(f'ğŸš« Revoking ghost certificate: {cert_id}...')
                      os.system(f'app-store-connect certificates revoke --id {cert_id}')
          except Exception as e:
              print(f'Error processing certs: {e}')
          "

          # 3. ä¸‹è½½æ‰€æœ‰çš„æè¿°æ–‡ä»¶
          app-store-connect profiles list --type IOS_APP_STORE --save-to-file profiles.json
          
          # 4. åˆ é™¤æ‰€æœ‰ç›¸å…³çš„æè¿°æ–‡ä»¶
          python3 -c "
          import json, os
          try:
              with open('profiles.json') as f:
                  data = json.load(f)
                  profiles = data.get('data', [])
                  for p in profiles:
                      p_id = p['id']
                      print(f'ğŸ—‘ï¸ Deleting profile: {p_id}...')
                      os.system(f'app-store-connect profiles delete --id {p_id}')
          except:
              pass
          "
          echo "âœ… Clean up complete. Ready to rebuild."

      - name: "Install & Build Web"
        script: |
          cd client/app
          npm install
          npm run build
          npx cap sync ios

      - name: "Initialize Keychain"
        script: keychain initialize

      - name: "Auto Code Signing (Force New)"
        script: |
          PROJECT_PATH="client/app/ios/App/App.xcodeproj"
          APP_ID=$(xcode-project detect-bundle-id --project "$PROJECT_PATH")
          
          # å¼ºåˆ¶åˆ›å»ºæ–°è¯ä¹¦
          app-store-connect fetch-signing-files "$APP_ID" --type IOS_APP_STORE --create
          
          keychain add-certificates

      - name: "Build IPA"
        script: |
          xcode-project use-profiles --project "client/app/ios/App/App.xcodeproj"
          xcode-project build-ipa \
            --workspace "client/app/ios/App/App.xcworkspace" \
            --scheme "App"

    artifacts:
      - client/app/ios/App/build/*.ipa