workflows:
  ios-manual-build:
    name: "ğŸ† Manual Signing Build (The Winner)"
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - manual_signing  # ğŸ‘ˆ å¯¹åº”ä½ åœ¨ç½‘é¡µä¸Šå»ºçš„ç»„å
      node: 20
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
    scripts:
      - name: "Install & Build Web"
        script: |
          cd client/app
          npm install
          npm run build
          npx cap sync ios

      - name: "Initialize Keychain"
        script: keychain initialize

      - name: "âœï¸ MANUAL SETUP: Import Certificate"
        script: |
          echo "æ­£åœ¨å¯¼å…¥æ‰‹åŠ¨ä¸Šä¼ çš„è¯ä¹¦..."
          # è§£ç  Base64 å˜é‡è¿˜åŸæˆæ–‡ä»¶
          echo $CM_CERTIFICATE | base64 --decode > /tmp/certificate.p12
          
          # å¯¼å…¥é’¥åŒ™ä¸²
          keychain add-certificates --certificate /tmp/certificate.p12 --certificate-password "$CM_CERTIFICATE_PASSWORD"

      - name: "ğŸ“ MANUAL SETUP: Import Profile"
        script: |
          echo "æ­£åœ¨å¯¼å…¥æ‰‹åŠ¨ä¸Šä¼ çš„æè¿°æ–‡ä»¶..."
          # è§£ç  Base64
          echo $CM_PROVISIONING_PROFILE | base64 --decode > /tmp/profile.mobileprovision
          
          # æ”¾åˆ° Xcode èƒ½æ‰¾åˆ°çš„åœ°æ–¹
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: "Build IPA"
        script: |
          # è¿™é‡Œçš„å…³é”®æ˜¯ä½¿ç”¨ manual æ¨¡å¼
          xcode-project build-ipa \
            --workspace "client/app/ios/App/App.xcworkspace" \
            --scheme "App" \
            --code-signing-identity "Apple Distribution" 
            # æ³¨æ„ï¼šå¦‚æœæ„å»ºå¤±è´¥æç¤ºæ‰¾ä¸åˆ° Profileï¼Œå¯èƒ½éœ€è¦åœ¨ Xcode å·¥ç¨‹é‡Œæ‰‹åŠ¨æŒ‡å®š
            # ä½†é€šå¸¸ xcode-project build-ipa ä¼šè‡ªåŠ¨åŒ¹é…åˆšæ‰æ”¾è¿›å»çš„ Profile

    artifacts:
      - client/app/ios/App/build/*.ipa